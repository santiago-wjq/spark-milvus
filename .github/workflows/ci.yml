name: CI

on:
  pull_request:
    branches: [main]

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    container:
      image: spark:4.0.1-scala2.13-java21-python3-ubuntu
      options: --user root

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      # 缓存步骤放在安装之前
      - name: Cache Conan packages
        uses: actions/cache@v4
        with:
          path: /root/.conan
          key: conan-${{ hashFiles('milvus-storage/cpp/conanfile.py') }}
          restore-keys: |
            conan-

      - name: Cache ccache
        uses: actions/cache@v4
        with:
          path: /root/.ccache
          key: ccache-${{ github.sha }}
          restore-keys: |
            ccache-

      - name: Cache sbt dependencies
        uses: actions/cache@v4
        with:
          path: |
            /root/.sbt
            /root/.ivy2/cache
            /root/.cache/coursier
          key: sbt-${{ hashFiles('build.sbt', 'project/*.sbt', 'project/*.scala') }}
          restore-keys: |
            sbt-

      - name: Install build dependencies
        run: |
          apt-get update
          apt-get install -y g++ gcc make ccache automake autoconf libtool curl wget

      - name: Install CMake
        run: |
          wget -qO- "https://cmake.org/files/v3.27/cmake-3.27.5-linux-x86_64.tar.gz" | tar --strip-components=1 -xz -C /usr/local

      - name: Install sbt
        run: |
          curl -fL https://github.com/sbt/sbt/releases/download/v1.11.1/sbt-1.11.1.tgz | tar xz -C /usr/local
          ln -s /usr/local/sbt/bin/sbt /usr/local/bin/sbt

      - name: Install Conan
        run: |
          pip3 install conan==1.61.0
          conan profile new default --detect || true
          conan profile update settings.compiler.libcxx=libstdc++11 default
          conan remote add default-conan-local https://milvus01.jfrog.io/artifactory/api/conan/default-conan-local --insert || true

      - name: Build milvus-storage native library
        run: |
          cd milvus-storage/cpp
          make build USE_JNI=True WITH_UT=False USE_ASAN=False

      - name: Copy native libraries
        run: |
          mkdir -p milvus-storage/java/native src/main/resources/native
          cp milvus-storage/cpp/build/Release/libmilvus-storage.so milvus-storage/java/native/
          cp milvus-storage/cpp/build/Release/libmilvus-storage-jni.so milvus-storage/java/native/
          cp milvus-storage/cpp/build/Release/libmilvus-storage.so src/main/resources/native/
          cp milvus-storage/cpp/build/Release/libmilvus-storage-jni.so src/main/resources/native/

      - name: Publish milvus-storage Java binding locally
        run: |
          cd milvus-storage/java
          sbt publishLocal

      - name: Compile
        run: sbt compile

      - name: Run unit tests
        run: |
          sbt 'testOnly \
            com.zilliz.spark.connector.MilvusOptionTest \
            com.zilliz.spark.connector.MilvusS3OptionTest \
            com.zilliz.spark.connector.DataTypeUtilTest \
            com.zilliz.spark.connector.filter.VectorBruteForceSearchTest \
            com.zilliz.spark.connector.operations.backfill.BackfillConfigTest \
            com.zilliz.spark.connector.loon.PropertiesTest \
            serde.SchemaUtilTest'
